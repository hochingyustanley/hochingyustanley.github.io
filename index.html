<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Beacon å¾©æ´»å°‹å¯¶</title>
    <!-- åŸºç¤åº«è¼‰å…¥ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.321.0/font/lucide.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans HK', sans-serif; 
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        .animate-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ä¿®æ­£æƒæå™¨å®¹å™¨æ¨£å¼ï¼Œé˜²æ­¢ç™½è‰²é–ƒçˆ */
        #qr-reader {
            width: 100% !important;
            border: none !important;
            background: #fff;
            border-radius: 1.5rem;
            overflow: hidden;
        }
        #qr-reader__scan_region video {
            border-radius: 1rem;
            object-fit: cover !important;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- åˆå§‹åŠ è¼‰ç‹€æ…‹ï¼Œé˜²æ­¢ç™½å± -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-sky-600 font-bold animate-pulse">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const correctAnswers = { 1: 'B', 2: 'B', 3: 'B', 4: 'B', 5: 'A' };
            const tasks = [
                { id: 1, location: 'é¢å‘èˆˆè¯è¡— (ç»ç’ƒå¹•ç‰†)', hint: 'ç•™æ„çª—å¤–çš„èŠ±åœ’å½¢ç‹€...' },
                { id: 2, location: 'é¢å‘è˜‡å±‹é‚¨ (åŒ—é¢çª—æˆ¶)', hint: 'è§€å¯Ÿå¤§å»ˆçš„åå­—...' },
                { id: 3, location: 'é¢å‘é †å¯§é“ (èˆŠå€æ–¹å‘)', hint: 'èä¸€èç©ºæ°£ä¸­çš„è±†é¦™...' },
                { id: 4, location: 'ä¸­å¿ƒå¤§å ‚ (æ–°è¨­æ–½å€)', hint: 'çœ‹çœ‹æˆ‘å€‘çš„è¨­è¨ˆæ¦‚å¿µ...' },
                { id: 5, location: 'ä¸­å¿ƒæ­£é–€ (å…¥å£è™•)', hint: 'æ­¡è¿ä¾†åˆ° The Beacon...' }
            ];

            const [userAnswers, setUserAnswers] = useState(() => {
                try {
                    const saved = localStorage.getItem('beacon_quest_answers');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) { return {}; }
            });
            
            const [gameState, setGameState] = useState('list'); 
            const [activeTask, setActiveTask] = useState(null);
            const [errorIds, setErrorIds] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date().toLocaleTimeString());
            const [uniqueId, setUniqueId] = useState('');
            const scannerInstance = useRef(null);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date().toLocaleTimeString()), 1000);
                
                // åˆå§‹åŒ– ID
                let savedId = localStorage.getItem('beacon_quest_user_id');
                if (!savedId) {
                    savedId = `BEACON-${Math.floor(100000 + Math.random() * 900000)}`;
                    localStorage.setItem('beacon_quest_user_id', savedId);
                }
                setUniqueId(savedId);

                // è™•ç† URL ç›´æ¥è¨ªå•
                const urlParams = new URLSearchParams(window.location.search);
                const taskId = parseInt(urlParams.get('task'));
                if (taskId && tasks.find(t => t.id === taskId)) {
                    setActiveTask(tasks.find(t => t.id === taskId));
                    setGameState('quiz');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                if (window.lucide) window.lucide.createIcons();
                return () => clearInterval(timer);
            }, []);

            // æƒæå™¨é‚è¼¯
            useEffect(() => {
                if (gameState === 'scan') {
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    const html5QrCode = new Html5Qrcode("qr-reader");
                    
                    const startScanner = async () => {
                        try {
                            await html5QrCode.start(
                                { facingMode: "environment" }, 
                                config,
                                (decodedText) => {
                                    try {
                                        const url = new URL(decodedText);
                                        const tid = parseInt(url.searchParams.get('task'));
                                        const found = tasks.find(t => t.id === tid);
                                        if (found) {
                                            html5QrCode.stop().then(() => {
                                                setActiveTask(found);
                                                setGameState('quiz');
                                            });
                                        }
                                    } catch (err) {
                                        console.log("Not a task URL");
                                    }
                                }
                            );
                            scannerInstance.current = html5QrCode;
                        } catch (err) {
                            alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ã€‚");
                            setGameState('list');
                        }
                    };

                    startScanner();
                }

                return () => {
                    if (scannerInstance.current && scannerInstance.current.isScanning) {
                        scannerInstance.current.stop().catch(e => console.error(e));
                    }
                };
            }, [gameState]);

            const handleAnswer = (option) => {
                const updated = { ...userAnswers, [activeTask.id]: option };
                setUserAnswers(updated);
                localStorage.setItem('beacon_quest_answers', JSON.stringify(updated));
                setGameState('list');
            };

            const checkFinal = () => {
                const mistakes = tasks.filter(t => userAnswers[t.id] !== correctAnswers[t.id]).map(t => t.id);
                if (mistakes.length === 0 && Object.keys(userAnswers).length === tasks.length) {
                    setGameState('result');
                } else {
                    setErrorIds(mistakes);
                    alert(Object.keys(userAnswers).length < tasks.length ? "è«‹å®Œæˆæ‰€æœ‰ä»»å‹™ï¼" : "éƒ¨åˆ†ç­”æ¡ˆæœ‰èª¤ï¼Œè«‹é‡è©¦ã€‚");
                }
            };

            return (
                <div className="min-h-screen max-w-md mx-auto bg-slate-50 shadow-inner overflow-x-hidden">
                    <header className="bg-sky-600 text-white p-6 rounded-b-[2rem] shadow-md text-center">
                        <h1 className="text-xl font-black tracking-tight">THE BEACON å¾©æ´»å°‹å¯¶</h1>
                        <p className="text-sky-200 text-xs mt-1">YMCA OF HONG KONG</p>
                    </header>

                    <main className="p-5">
                        {gameState === 'list' && (
                            <div className="animate-in space-y-4">
                                <button onClick={() => setGameState('scan')} className="w-full bg-yellow-400 p-5 rounded-2xl font-black text-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all">
                                    <i data-lucide="camera"></i> æƒæ QR CODE è§£é–
                                </button>
                                
                                <div className="space-y-3">
                                    {tasks.map(t => (
                                        <div key={t.id} className={`p-4 rounded-xl border-2 flex items-center justify-between ${userAnswers[t.id] ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100'}`}>
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${userAnswers[t.id] ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-400'}`}>
                                                    {t.id}
                                                </div>
                                                <div className="text-sm font-bold text-slate-600">{t.location}</div>
                                            </div>
                                            {userAnswers[t.id] && <i data-lucide="check-circle-2" className="text-green-500"></i>}
                                        </div>
                                    ))}
                                </div>

                                <button onClick={checkFinal} disabled={Object.keys(userAnswers).length < tasks.length} className={`w-full py-4 rounded-xl font-bold mt-4 ${Object.keys(userAnswers).length === tasks.length ? 'bg-sky-600 text-white shadow-md' : 'bg-slate-200 text-slate-400'}`}>
                                    æäº¤æª¢æŸ¥
                                </button>
                            </div>
                        )}

                        {gameState === 'scan' && (
                            <div className="animate-in text-center space-y-4">
                                <div id="qr-reader" className="shadow-xl"></div>
                                <button onClick={() => setGameState('list')} className="text-slate-500 font-bold py-2 px-6 bg-white rounded-full shadow-sm border border-slate-100">å–æ¶ˆæƒæ</button>
                            </div>
                        )}

                        {gameState === 'quiz' && activeTask && (
                            <div className="animate-in space-y-6">
                                <div className="bg-white p-8 rounded-3xl shadow-xl border-t-8 border-yellow-400 text-center">
                                    <h2 className="font-bold text-slate-500 mb-2">ä»»å‹™ #{activeTask.id}</h2>
                                    <p className="text-lg font-black text-slate-800 mb-6">{activeTask.location}</p>
                                    <div className="grid grid-cols-2 gap-3">
                                        {['A', 'B', 'C', 'D'].map(opt => (
                                            <button key={opt} onClick={() => handleAnswer(opt)} className="h-20 bg-slate-50 border-2 border-slate-100 rounded-xl text-2xl font-black text-slate-700 active:bg-sky-500 active:text-white transition-colors">
                                                {opt}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="mt-6 p-4 bg-yellow-50 rounded-xl text-left text-xs text-yellow-800">
                                        <strong>æç¤ºï¼š</strong> {activeTask.hint}
                                    </div>
                                </div>
                            </div>
                        )}

                        {gameState === 'result' && (
                            <div className="animate-in text-center space-y-6">
                                <div className="bg-white p-8 rounded-3xl shadow-2xl border-4 border-yellow-400">
                                    <div className="text-5xl mb-4">ğŸ¥³</div>
                                    <h2 className="text-2xl font-black text-slate-800">æ­å–œå…¨éƒ¨ç­”å°ï¼</h2>
                                    <div className="my-6 bg-slate-900 p-6 rounded-2xl text-white">
                                        <p className="text-[10px] text-slate-400 mb-2 uppercase tracking-widest">æ›é ˜ç·¨è™Ÿ</p>
                                        <p className="text-2xl font-mono font-bold text-yellow-300">{uniqueId}</p>
                                        <div className="mt-4 pt-4 border-t border-slate-800 text-lg font-bold">{currentTime}</div>
                                    </div>
                                    <p className="text-xs text-slate-400 italic">è«‹å‘æ«ƒæª¯è·å“¡å±•ç¤ºæ­¤ç•«é¢</p>
                                </div>
                                <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="text-slate-300 text-xs underline">é‡ç½®æ‰€æœ‰é€²åº¦</button>
                            </div>
                        )}
                    </main>
                    
                    <footer className="py-8 text-center text-[10px] text-slate-300 uppercase tracking-widest">
                        The Beacon Â© 2026 YMCA OF HK
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>